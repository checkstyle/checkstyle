name: CI â™»ï¸
version: 2.1

jobs:

  run-inspections:
    docker:
      - image: amitkumardeoghoria/idea-image:jdk21-idea2022.3.3-v1

    steps:
      - checkout
      - run:
          name: Print versions ğŸ“Š
          command: |
            echo "Maven version:"
            ./mvnw --version
            echo "Java version:"
            java --version
            echo "IDEA version:"
            echo $IDEA_VERSION
      - run:
          name: Run inspections ğŸ”
          command: |
            mkdir .idea
            cp config/intellij-idea-inspections-misc.xml .idea/misc.xml
            ./.ci/idea-inspection.sh
          no_output_timeout: 25m
          working_directory: ~/project
      - store_artifacts:
          path: /home/circleci/project/target/inspection-results

  validate-with-maven-script:
    description: Runs a maven script using the job name as the argument.
    parameters: &script_parameters
      image-name:
        type: string
        default: cimg/openjdk:21.0.6
        description: docker image to use
      command:
        description: command to run
        type: string
        default: ""
    docker:
      - image: << parameters.image-name >>
    steps:
      - checkout
      - restore_cache:
          name: Restore Maven repo and wrapper cache ğŸ”„
          keys:
            - mvn-cache-{{ checksum "pom.xml" }}
      - run:
          command: << parameters.command >>
      - run:
          command: |
            ./.ci/validation.sh git-diff
            ./.ci/validation.sh ci-temp-check
      - save_cache:
          name: Save Maven repo and wrapper cache ğŸ’¾
          key: mvn-cache-{{ checksum "pom.xml" }}
          paths:
            - .m2
            - .mvn/wrapper

  validate-with-script:
    description: Runs a non-maven script using the job name as the argument.
    parameters: *script_parameters
    docker:
      - image: << parameters.image-name >>
    steps:
      - checkout
      - run:
          name: Run << parameters.command >> ğŸ—ï¸
          command: |
            sudo apt update
            sudo apt install -y xmlstarlet --no-install-recommends apt-utils
            export PULL_REQUEST=$CIRCLE_PR_NUMBER
            export PR_HEAD_SHA=$CIRCLE_SHA1
            export PR_NUMBER=$CIRCLE_PR_NUMBER
            << parameters.command >>

  sonarqube:
    docker:
      - image: amitkumardeoghoria/jdk-21-groovy-git-mvn-ant-jq:v1

    steps:
      - checkout
      - run:
          name: Run SonarQube ğŸ“ˆ
          command: |
            export PR_NUMBER=$CIRCLE_PR_NUMBER
            export PR_BRANCH_NAME=$CIRCLE_BRANCH
            export SONAR_API_TOKEN=$SONAR_TOKEN
            ./.ci/validation.sh sonarqube

  yamllint:
    docker:
      - image: cimg/base:2022.11

    steps:
      - checkout
      - run:
          name: Install dependencies ğŸ“¦
          command: |
            sudo apt update
            sudo apt install -y yamllint
      - run:
          name: Run yamllint âœ…
          command: yamllint -f parsable -c config/yamllint.yaml .

workflows:
  #  sonarqube:
  #    jobs:
  #      - sonarqube:
  #          context:
  #            - sonarqube

  test:
    jobs:
      # no-exception-test script
      - validate-with-maven-script:
          name: no-exception-lucene-and-others-javadoc ğŸ“š
          image-name: &cs_img amitkumardeoghoria/jdk-21-groovy-git-mvn-ant-jq:v1
          command: ./.ci/no-exception-test.sh no-exception-lucene-and-others-javadoc
      - validate-with-maven-script:
          name: no-exception-cassandra-storm-tapestry-javadoc ğŸ“š
          image-name: *cs_img
          command: ./.ci/no-exception-test.sh no-exception-cassandra-storm-tapestry-javadoc
      - validate-with-maven-script:
          name: no-exception-hadoop-apache-groovy-scouter-javadoc ğŸ“š
          image-name: *cs_img
          command: ./.ci/no-exception-test.sh no-exception-hadoop-apache-groovy-scouter-javadoc
      - validate-with-maven-script:
          name: no-exception-only-javadoc ğŸ“š
          image-name: *cs_img
          command: ./.ci/no-exception-test.sh no-exception-only-javadoc

      # validation script
      - validate-with-maven-script:
          name: no-error-xwiki âœ…
          image-name: cimg/openjdk:21.0.6
          command: ./.ci/validation.sh no-error-xwiki
      - validate-with-maven-script:
          name: no-error-pmd âœ…
          image-name: *cs_img
          command: ./.ci/validation.sh no-error-pmd
      - validate-with-maven-script:
          name: no-exception-struts âœ…
          image-name: *cs_img
          command: ./.ci/validation.sh no-exception-struts
      - validate-with-maven-script:
          name: no-exception-checkstyle-sevntu âœ…
          image-name: *cs_img
          command: ./.ci/validation.sh no-exception-checkstyle-sevntu
      - validate-with-maven-script:
          name: no-exception-checkstyle-sevntu-javadoc ğŸ“š
          image-name: *cs_img
          command: ./.ci/validation.sh no-exception-checkstyle-sevntu-javadoc
      - validate-with-maven-script:
          name: no-exception-guava âœ…
          image-name: *cs_img
          command: ./.ci/validation.sh no-exception-guava
      - validate-with-maven-script:
          name: no-exception-hibernate-orm âœ…
          image-name: *cs_img
          command: ./.ci/validation.sh no-exception-hibernate-orm
      - validate-with-maven-script:
          name: no-exception-spotbugs âœ…
          image-name: *cs_img
          command: ./.ci/validation.sh no-exception-spotbugs
      - validate-with-maven-script:
          name: no-exception-spoon âœ…
          image-name: *cs_img
          command: ./.ci/validation.sh no-exception-spoon
      - validate-with-maven-script:
          name: no-exception-spring-framework âœ…
          image-name: *cs_img
          command: ./.ci/validation.sh no-exception-spring-framework
      - validate-with-maven-script:
          name: no-exception-hbase âœ…
          image-name: *cs_img
          command: ./.ci/validation.sh no-exception-hbase
      - validate-with-maven-script:
          name: no-exception-pmd-elasticsearch-lombok-ast âœ…
          image-name: *cs_img
          command: ./.ci/validation.sh no-exception-pmd-elasticsearch-lombok-ast
      - validate-with-maven-script:
          name: no-exception-a-lot-of-projects âœ…
          image-name: *cs_img
          command: ./.ci/validation.sh no-exception-alot-of-projects
      - validate-with-maven-script:
          name: no-warning-imports-guava âœ…
          image-name: *cs_img
          command: ./.ci/validation.sh no-warning-imports-guava
      - validate-with-maven-script:
          name: no-warning-imports-java-design-patterns âœ…
          image-name: *cs_img
          command: ./.ci/validation.sh no-warning-imports-java-design-patterns
      - validate-with-maven-script:
          name: checkstyle-and-sevntu âœ…
          image-name: *cs_img
          command: ./.ci/validation.sh checkstyle-and-sevntu
      # https://github.com/spotbugs/spotbugs-maven-plugin/issues/806 explains
      # why we need execution of spotbugs without any other maven plugins which can change binaries
      - validate-with-maven-script:
          name: spotbugs-and-pmd âœ…
          image-name: *cs_img
          command: ./.ci/validation.sh spotbugs-and-pmd
      - validate-with-maven-script:
          name: site ğŸŒ
          image-name: *cs_img
          command: ./.ci/validation.sh site
      - validate-with-maven-script:
          name: release-dry-run ğŸ§ª
          image-name: *cs_img
          command: ./.ci/validation.sh release-dry-run
      - validate-with-maven-script:
          name: assembly-run-all-jar ğŸ“¦
          image-name: *cs_img
          command: ./.ci/validation.sh assembly-run-all-jar
      - validate-with-maven-script:
          name: no-error-test-sbe âœ…
          image-name: cimg/openjdk:21.0.6
          command: ./.ci/validation.sh no-error-test-sbe
      - validate-with-maven-script:
          name: no-error-spotbugs âœ…
          image-name: *cs_img
          command: ./.ci/validation.sh no-error-spotbugs
      - validate-with-maven-script:
          name: no-error-pgjdbc âœ…
          image-name: cimg/openjdk:21.0
          command: ./.ci/validation.sh no-error-pgjdbc
      - validate-with-maven-script:
          name: linkcheck-plugin ğŸ”—
          image-name: cimg/openjdk:21.0.6
          command: ./.ci/run-link-check-plugin.sh --skip-external
      - validate-with-maven-script:
          name: no-exception-samples-gradle ğŸ“š
          image-name: cimg/openjdk:17.0.7
          command: ./.ci/no-exception-test.sh no-exception-samples-gradle
      - validate-with-maven-script:
          name: no-exception-samples-maven ğŸ“š
          image-name: cimg/openjdk:21.0.6
          command: ./.ci/no-exception-test.sh no-exception-samples-maven

      - validate-with-maven-script:
          name: no-exception-samples-ant ğŸ“š
          image-name: *cs_img
          command: ./.ci/no-exception-test.sh no-exception-samples-ant
      - validate-with-maven-script:
          name: no-error-hazelcast âœ…
          image-name: *cs_img
          command: ./.ci/validation.sh no-error-hazelcast

  idea:
    jobs:
      - run-inspections

  git-validation:
    jobs:
      - validate-with-script:
          name: git-no-merge-commits âœ…
          command: ./.ci/validation.sh git-no-merge-commits
      - validate-with-script:
          name: git-check-pull-number ğŸ”¢
          command: ./.ci/validation.sh git-check-pull-number

  cli-validation:
    jobs:
      - yamllint
      - validate-with-script:
          name: checkchmod ğŸ”’
          command: ./.ci/checkchmod.sh
      - validate-with-script:
          name: check-github-workflows-concurrency ğŸ”„
          command: ./.ci/validation.sh check-github-workflows-concurrency
      - validate-with-script:
          name: check-wildcards-on-pitest-target-classes ğŸ¯
          image-name: cimg/base:2022.11
          command: ./.ci/validation.sh check-wildcards-on-pitest-target-classes

  javac-validation:
    jobs:
      - validate-with-script:
          name: check-since-version ğŸ“…
          command: ./.ci/validation.sh check-since-version
      - validate-with-script:
          name: javac-17-standard â˜•ï¸
          image-name: cimg/openjdk:17.0.7
          command: ./.ci/validation.sh javac17_standard
      - validate-with-script:
          name: javac-17 â˜•ï¸
          image-name: cimg/openjdk:17.0.7
          command: ./.ci/validation.sh javac17
      - validate-with-script:
          name: java-21-test-resources-compile â˜•ï¸
          image-name: cimg/openjdk:21.0.8
          command: ./.ci/validation.sh compile-test-resources
      - validate-with-script:
          name: javac-19 â˜•ï¸
          image-name: cimg/openjdk:19.0.1
          command: ./.ci/validation.sh javac19
      - validate-with-script:
          name: javac-20 â˜•ï¸
          image-name: cimg/openjdk:20.0.1
          command: ./.ci/validation.sh javac20
      - validate-with-script:
          name: javac-21 â˜•ï¸
          image-name: cimg/openjdk:21.0.6
          command: ./.ci/validation.sh javac21
      - validate-with-script:
          name: javac-22 â˜•ï¸
          image-name: cimg/openjdk:22.0.2
          command: ./.ci/validation.sh javac22
      - validate-with-script:
          name: javac-25 â˜•ï¸
          image-name: cimg/openjdk:25.0
          command: ./.ci/validation.sh javac25

  site-validation:
    jobs:
      - validate-with-maven-script:
          name: jdk21-package-site â˜•ï¸
          image-name: *cs_img
          command: ./.ci/validation.sh package-site

  sanity:
    jobs:
      - validate-with-maven-script:
          name: Sanity Check ğŸ•Šï¸
          image-name: cimg/openjdk:21.0
          command: ./.ci/validation.sh sanity

  spotless:
    jobs:
      - validate-with-maven-script:
          name: Spotless âœ¨
          image-name: cimg/openjdk:21.0
          command: ./.ci/validation.sh spotless
