name: "CI â™»ï¸"
version: "2.1"
jobs:
  run-inspections:
    docker:
      - image: "amitkumardeoghoria/idea-image:jdk21-idea2022.3.3-v1"
    steps:
      - checkout
      - run:
          name: "Print Versions ğŸ“‹"
          command: |
            echo "Maven version:"
            ./mvnw --version
            echo "Java version:"
            java --version
            echo "IDEA version:"
            echo $IDEA_VERSION
      - run:
          name: "Run Inspections ğŸš€"
          command: |
            mkdir .idea
            cp config/intellij-idea-inspections-misc.xml .idea/misc.xml
            ./.ci/idea-inspection.sh
          no_output_timeout: "25m"
          working_directory: "~/project"
      - store_artifacts:
          name: "Store Artifacts ğŸ“¦"
          path: "/home/circleci/project/target/inspection-results"
  validate-with-maven-script:
    description: "Runs a maven script using the job name as the argument."
    parameters: &script_parameters
      image-name:
        type: "string"
        default: "cimg/openjdk:21.0.6"
        description: "docker image to use"
      command:
        description: "command to run"
        type: "string"
        default: ""
    docker:
      - image: "<< parameters.image-name >>"
    steps:
      - checkout
      - restore_cache:
          name: "Restore Cache ğŸ”„"
          keys:
            - "mvn-cache-{{ checksum \"pom.xml\" }}"
      - run:
          name: "Execute Command âš¡"
          command: "<< parameters.command >>"
      - run:
          name: "Run Validation Scripts âœ…"
          command: |
            ./.ci/validation.sh git-diff
            ./.ci/validation.sh ci-temp-check
      - save_cache:
          name: "Save Cache ğŸ’¾"
          key: "mvn-cache-{{ checksum \"pom.xml\" }}"
          paths:
            - ".m2"
            - ".mvn/wrapper"
  validate-with-script:
    description: "Runs a non-maven script using the job name as the argument."
    parameters: *script_parameters
    docker:
      - image: "<< parameters.image-name >>"
    steps:
      - checkout
      - run:
          name: "Run Validation Script ğŸ› ï¸"
          command: |
            sudo apt update
            sudo apt install -y xmlstarlet --no-install-recommends apt-utils
            export PULL_REQUEST=$CIRCLE_PR_NUMBER
            export PR_HEAD_SHA=$CIRCLE_SHA1
            export PR_NUMBER=$CIRCLE_PR_NUMBER
            << parameters.command >>
  sonarqube:
    docker:
      - image: "amitkumardeoghoria/jdk-21-groovy-git-mvn-ant-jq:v1"
    steps:
      - checkout
      - run:
          name: "Run SonarQube ğŸš€"
          command: |
            export PR_NUMBER=$CIRCLE_PR_NUMBER
            export PR_BRANCH_NAME=$CIRCLE_BRANCH
            export SONAR_API_TOKEN=$SONAR_TOKEN
            ./.ci/validation.sh sonarqube
  yamllint:
    name: "YAML Lint âœ…"
    docker:
      - image: "cimg/base:2022.11"
    steps:
      - checkout
      - run:
          name: "Install Dependencies ğŸ“¥"
          command: |
            sudo apt update
            sudo apt install -y yamllint
      - run:
          name: "Run YAML Lint ğŸš€"
          command: "yamllint -f parsable -c config/yamllint.yaml ."
workflows:
  test:
    jobs:
      - validate-with-maven-script:
          name: "No Exception Lucene Javadoc ğŸ“š"
          image-name: &cs_img "amitkumardeoghoria/jdk-21-groovy-git-mvn-ant-jq:v1"
          command: "./.ci/no-exception-test.sh no-exception-lucene-and-others-javadoc"
      - validate-with-maven-script:
          name: "No Exception Cassandra Javadoc ğŸ“š"
          image-name: *cs_img
          command: "./.ci/no-exception-test.sh no-exception-cassandra-storm-tapestry-javadoc"
      - validate-with-maven-script:
          name: "No Exception Hadoop Javadoc ğŸ“š"
          image-name: *cs_img
          command: "./.ci/no-exception-test.sh no-exception-hadoop-apache-groovy-scouter-javadoc"
      - validate-with-maven-script:
          name: "No Exception Only Javadoc ğŸ“š"
          image-name: *cs_img
          command: "./.ci/no-exception-test.sh no-exception-only-javadoc"
      - validate-with-maven-script:
          name: "No Error XWiki âœ…"
          image-name: "cimg/openjdk:21.0.6"
          command: "./.ci/validation.sh no-error-xwiki"
      - validate-with-maven-script:
          name: "No Error PMD âœ…"
          image-name: *cs_img
          command: "./.ci/validation.sh no-error-pmd"
      - validate-with-maven-script:
          name: "No Exception Struts âœ…"
          image-name: *cs_img
          command: "./.ci/validation.sh no-exception-struts"
      - validate-with-maven-script:
          name: "No Exception Checkstyle âœ…"
          image-name: *cs_img
          command: "./.ci/validation.sh no-exception-checkstyle-sevntu"
      - validate-with-maven-script:
          name: "No Exception Checkstyle Javadoc ğŸ“š"
          image-name: *cs_img
          command: "./.ci/validation.sh no-exception-checkstyle-sevntu-javadoc"
      - validate-with-maven-script:
          name: "No Exception Guava âœ…"
          image-name: *cs_img
          command: "./.ci/validation.sh no-exception-guava"
      - validate-with-maven-script:
          name: "No Exception Hibernate âœ…"
          image-name: *cs_img
          command: "./.ci/validation.sh no-exception-hibernate-orm"
      - validate-with-maven-script:
          name: "No Exception SpotBugs âœ…"
          image-name: *cs_img
          command: "./.ci/validation.sh no-exception-spotbugs"
      - validate-with-maven-script:
          name: "No Exception Spoon âœ…"
          image-name: *cs_img
          command: "./.ci/validation.sh no-exception-spoon"
      - validate-with-maven-script:
          name: "No Exception Spring âœ…"
          image-name: *cs_img
          command: "./.ci/validation.sh no-exception-spring-framework"
      - validate-with-maven-script:
          name: "No Exception HBase âœ…"
          image-name: *cs_img
          command: "./.ci/validation.sh no-exception-hbase"
      - validate-with-maven-script:
          name: "No Exception PMD ElasticSearch âœ…"
          image-name: *cs_img
          command: "./.ci/validation.sh no-exception-Pmd-elasticsearch-lombok-ast"
      - validate-with-maven-script:
          name: "No Exception Many Projects âœ…"
          image-name: *cs_img
          command: "./.ci/validation.sh no-exception-alot-of-projects"
      - validate-with-maven-script:
          name: "No Warning Imports Guava âš ï¸"
          image-name: *cs_img
          command: "./.ci/validation.sh no-warning-imports-guava"
      - validate-with-maven-script:
          name: "No Warning Imports Design Patterns âš ï¸"
          image-name: *cs_img
          command: "./.ci/validation.sh no-warning-imports-java-design-patterns"
      - validate-with-maven-script:
          name: "Checkstyle and Sevntu âœ…"
          image-name: *cs_img
          command: "./.ci/validation.sh checkstyle-and-sevntu"
      - validate-with-maven-script:
          name: "SpotBugs and PMD âœ…"
          image-name: *cs_img
          command: "./.ci/validation.sh spotbugs-and-pmd"
      - validate-with-maven-script:
          name: "Site Generation ğŸŒ"
          image-name: *cs_img
          command: "./.ci/validation.sh site"
      - validate-with-maven-script:
          name: "Release Dry Run ğŸš€"
          image-name: *cs_img
          command: "./.ci/validation.sh release-dry-run"
      - validate-with-maven-script:
          name: "Assembly Run All JAR ğŸ“¦"
          image-name: *cs_img
          command: "./.ci/validation.sh assembly-run-all-jar"
      - validate-with-maven-script:
          name: "No Error Test SBE âœ…"
          image-name: "cimg/openjdk:21.0.6"
          command: "./.ci/validation.sh no-error-test-sbe"
      - validate-with-maven-script:
          name: "No Error SpotBugs âœ…"
          image-name: *cs_img
          command: "./.ci/validation.sh no-error-spotbugs"
      - validate-with-maven-script:
          name: "No Error PGJDBC âœ…"
          image-name: "cimg/openjdk:21.0"
          command: "./.ci/validation.sh no-error-pgjdbc"
      - validate-with-maven-script:
          name: "Link Check Plugin ğŸ”—"
          image-name: "cimg/openjdk:21.0.6"
          command: "./.ci/run-link-check-plugin.sh --skip-external"
      - validate-with-maven-script:
          name: "No Exception Gradle Samples âœ…"
          image-name: "cimg/openjdk:17.0.7"
          command: "./.ci/no-exception-test.sh no-exception-samples-gradle"
      - validate-with-maven-script:
          name: "No Exception Maven Samples âœ…"
          image-name: "cimg/openjdk:21.0.6"
          command: "./.ci/no-exception-test.sh no-exception-samples-maven"
      - validate-with-maven-script:
          name: "No Exception Ant Samples âœ…"
          image-name: *cs_img
          command: "./.ci/no-exception-test.sh no-exception-samples-ant"
      - validate-with-maven-script:
          name: "No Error Hazelcast âœ…"
          image-name: *cs_img
          command: "./.ci/validation.sh no-error-hazelcast"
  idea:
    jobs:
      - run-inspections
  git-validation:
    jobs:
      - validate-with-script:
          name: "Git No Merge Commits ğŸš«"
          command: "./.ci/validation.sh git-no-merge-commits"
      - validate-with-script:
          name: "Git Check Pull Number ğŸ”¢"
          command: "./.ci/validation.sh git-check-pull-number"
  cli-validation:
    jobs:
      - yamllint
      - validate-with-script:
          name: "Check CHMOD Permissions ğŸ”"
          command: "./.ci/checkchmod.sh"
      - validate-with-script:
          name: "Check GitHub Workflows Concurrency ğŸ”„"
          command: "./.ci/validation.sh check-github-workflows-concurrency"
      - validate-with-script:
          name: "Check Wildcards on Pitest ğŸ¯"
          image-name: "cimg/base:2022.11"
          command: "./.ci/validation.sh check-wildcards-on-pitest-target-classes"
  javac-validation:
    jobs:
      - validate-with-script:
          name: "Check Since Version ğŸ”"
          command: "./.ci/validation.sh check-since-version"
      - validate-with-script:
          name: "JavaC 17 Standard ğŸŸ¢"
          image-name: "cimg/openjdk:17.0.7"
          command: "./.ci/validation.sh javac17_standard"
      - validate-with-script:
          name: "JavaC 17 ğŸŸ¢"
          image-name: "cimg/openjdk:17.0.7"
          command: "./.ci/validation.sh javac17"
      - validate-with-script:
          name: "Java 21 Test Resources Compile ğŸ§ª"
          image-name: "cimg/openjdk:21.0.8"
          command: "./.ci/validation.sh compile-test-resources"
      - validate-with-script:
          name: "JavaC 19 ğŸŸ¢"
          image-name: "cimg/openjdk:19.0.1"
          command: "./.ci/validation.sh javac19"
      - validate-with-script:
          name: "JavaC 20 ğŸŸ¢"
          image-name: "cimg/openjdk:20.0.1"
          command: "./.ci/validation.sh javac20"
      - validate-with-script:
          name: "JavaC 21 ğŸŸ¢"
          image-name: "cimg/openjdk:21.0.6"
          command: "./.ci/validation.sh javac21"
      - validate-with-script:
          name: "JavaC 22 ğŸŸ¢"
          image-name: "cimg/openjdk:22.0.2"
          command: "./.ci/validation.sh javac22"
      - validate-with-script:
          name: "JavaC 25 ğŸŸ¢"
          image-name: "cimg/openjdk:25.0"
          command: "./.ci/validation.sh javac25"
  site-validation:
    jobs:
      - validate-with-maven-script:
          name: "JDK 21 Package Site ğŸ“¦"
          image-name: *cs_img
          command: "./.ci/validation.sh package-site"
  sanity:
    jobs:
      - validate-with-maven-script:
          name: "Sanity Check ğŸ¦¢"
          image-name: "cimg/openjdk:21.0"
          command: "./.ci/validation.sh sanity-check"
  spotless:
    jobs:
      - validate-with-maven-script:
          name: "Spotless âœ¨"
          image-name: "cimg/openjdk:21.0"
          command: "./.ci/validation.sh spotless"
