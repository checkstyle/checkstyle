version: 2
jobs:

  build-caches:
    machine: true
    java:
      version: oraclejdk8
    steps:
      # restore_cache.keys does not work, so multiple restore_cache.key is used
      - restore_cache:
          key: m2-cache
      - checkout
      - run:
          name: skip_ci creation
          command: |
            mkdir -p .ci-temp
            echo -n ".github|appveyor.yml|.travis.yml|\.ci/" >> .ci-temp/skip_ci_files
            echo -n "|distelli-manifest.yml|fast-forward-merge.sh" >> .ci-temp/skip_ci_files
            echo -n "|LICENSE|LICENSE.apache20|README.md|release.sh" >> .ci-temp/skip_ci_files
            echo -n "|RIGHTS.antlr|shippable.yml" >> .ci-temp/skip_ci_files
            echo -n "|shippable.sh|wercker.yml|wercker.sh" >> .ci-temp/skip_ci_files
            echo -n "|intellij-idea-inspections.xml" >> .ci-temp/skip_ci_files
            echo -n "|org.eclipse.jdt.core.prefs" >> .ci-temp/skip_ci_files
      - run:
          name: download all maven dependencies and groovy
          command: |
            if [ $(git diff --name-only HEAD HEAD~1 \
                   | grep -vE $(cat .ci-temp/skip_ci_files) | wc -c) -gt 0 ] ; then
              pwd
              ls -la
              java -version
              mvn --version
              mvn -e -Ppitest-metrics clean test org.pitest:pitest-maven:mutationCoverage \
                  -Dpit.report.skip=true;
            fi
      - save_cache:
          # Save by timestamp , but will be restored by prefix without timestamp (most recent)
          #https://discuss.circleci.com/t/add-mechanism-to-update-existing-cache-key/9014/13
          key: m2-cache-epoch-{{ epoch }}
          paths:
            - /home/circleci/.m2/repository
      - save_cache:
          key: source-cache-{{ .Environment.CIRCLE_SHA1 }}
          paths:
            - /home/circleci/project
            - /home/circleci/contribution

  test-pitest1:
    machine: true
    java:
      version: oraclejdk8
    parallelism: 4
    steps:
      # restore_cache.keys does not work, so multiple restore_cache.key is used
      - restore_cache:
          key: m2-cache
      - restore_cache:
          key: source-cache-{{ .Environment.CIRCLE_SHA1 }}
      - run:
          command: |
             echo "./.ci/shippable.sh pitest-coding"  >> commands.txt
             echo "./.ci/shippable.sh pitest-utils"   >> commands.txt
             echo "./.ci/shippable.sh pitest-packagenamesloader"   >> commands.txt
             echo "./.ci/shippable.sh pitest-naming"   >> commands.txt
             CMD="$(circleci tests split commands.txt)"
             echo "Command: $CMD"
             eval $CMD

  test-pitest2:
    machine: true
    java:
      version: oraclejdk8
    parallelism: 4
    steps:
      # restore_cache.keys does not work, so multiple restore_cache.key is used
      - restore_cache:
          key: m2-cache
      - restore_cache:
          key: source-cache-{{ .Environment.CIRCLE_SHA1 }}
      - run:
          command: |
             echo "./.ci/shippable.sh pitest-common"   >> commands.txt
             echo "./.ci/shippable.sh pitest-api"   >> commands.txt
             echo "./.ci/shippable.sh pitest-tree-walker"   >> commands.txt
             echo "./.ci/shippable.sh pitest-modifier"   >> commands.txt
             CMD="$(circleci tests split commands.txt)"
             echo "Command: $CMD"
             eval $CMD

  test-pitest3:
    machine: true
    java:
      version: oraclejdk8
    parallelism: 4
    steps:
      # restore_cache.keys does not work, so multiple restore_cache.key is used
      - restore_cache:
          key: m2-cache
      - restore_cache:
          key: source-cache-{{ .Environment.CIRCLE_SHA1 }}
      - run:
          command: |
             echo "./.ci/shippable.sh pitest-imports"   >> commands.txt
             echo "./.ci/shippable.sh pitest-design"   >> commands.txt
             echo "./.ci/shippable.sh pitest-header"   >> commands.txt
             echo "./.ci/shippable.sh pitest-blocks"   >> commands.txt
             CMD="$(circleci tests split commands.txt)"
             echo "Command: $CMD"
             eval $CMD

  test-pitest4:
    machine: true
    java:
      version: oraclejdk8
    parallelism: 4
    steps:
      # restore_cache.keys does not work, so multiple restore_cache.key is used
      - restore_cache:
          key: m2-cache
      - restore_cache:
          key: source-cache-{{ .Environment.CIRCLE_SHA1 }}
      - run:
          command: |
             echo "./.ci/shippable.sh pitest-ant"   >> commands.txt
             echo "./.ci/shippable.sh pitest-misc"   >> commands.txt
             echo "./.ci/shippable.sh pitest-annotation"   >> commands.txt
             echo "./.ci/shippable.sh pitest-sizes"   >> commands.txt
             CMD="$(circleci tests split commands.txt)"
             echo "Command: $CMD"
             eval $CMD

  test-pitest5:
    machine: true
    java:
      version: oraclejdk8
    parallelism: 4
    steps:
      # restore_cache.keys does not work, so multiple restore_cache.key is used
      - restore_cache:
          key: m2-cache
      - restore_cache:
          key: source-cache-{{ .Environment.CIRCLE_SHA1 }}
      - run:
          command: |
             echo "./.ci/shippable.sh pitest-main"   >> commands.txt
             echo "./.ci/shippable.sh pitest-xpath"   >> commands.txt
             echo "./.ci/shippable.sh pitest-whitespace"   >> commands.txt
             echo "./.ci/shippable.sh pitest-regexp"   >> commands.txt
             CMD="$(circleci tests split commands.txt)"
             echo "Command: $CMD"
             eval $CMD

  test-pitest6:
    machine: true
    java:
      version: oraclejdk8
    parallelism: 4
    steps:
      # restore_cache.keys does not work, so multiple restore_cache.key is used
      - restore_cache:
          key: m2-cache
      - restore_cache:
          key: source-cache-{{ .Environment.CIRCLE_SHA1 }}
      - run:
          command: |
             echo "./.ci/shippable.sh pitest-javadoc"   >> commands.txt
             echo "./.ci/shippable.sh pitest-indentation"   >> commands.txt
             echo "./.ci/shippable.sh pitest-filters"   >> commands.txt
             echo "./.ci/shippable.sh pitest-metrics"   >> commands.txt
             CMD="$(circleci tests split commands.txt)"
             echo "Command: $CMD"
             eval $CMD

workflows:
  version: 2
  regression-testing:
    jobs:
      - build-caches
      - test-pitest1:
          requires:
            - build-caches
      - test-pitest2:
          requires:
            - build-caches
      - test-pitest3:
          requires:
            - build-caches
      - test-pitest4:
          requires:
            - build-caches
      - test-pitest5:
          requires:
            - build-caches
      - test-pitest6:
          requires:
            - build-caches
