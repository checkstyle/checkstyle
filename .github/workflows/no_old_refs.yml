#####################################################################################
# GitHub Action to check references to closed issues in code.
#
# Workflow starts when:
# 1) push on master branch
# 2) pull request is opened or synchronized or reopened
#
#####################################################################################
name: "Check no closed issue references"

on:
  push:
    branches: [ master ]
  pull_request:

jobs:
  check_issues:
    runs-on: ubuntu-latest
    steps:
      - name: Download checkstyle
        uses: actions/checkout@v2
      - name: PR linked issues
        id: links
        uses: mondeja/pr-linked-issues-action@v2
        if: github.event_name == 'pull_request'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      #######################################################################
      # Linked issues, if present, are received in the following format:
      # 37,38
      # We convert it into:
      # https://github.com/checkstyle/checkstyle/issues/37
      # https://github.com/checkstyle/checkstyle/issues/38
      #######################################################################
      - name: Format linked issues
        id: format-linked-issues
        if: github.event_name == 'pull_request'
        run: |
          LINKED_ISSUES=${{ steps.links.outputs.issues }}
          LINKED_ISSUES_FORMATTED=/tmp/linked_issues
          CHECKSTYLE_ISSUE_URL="https:\/\/github.com\/checkstyle\/checkstyle\/issues\/"
          if [ ! -z "$LINKED_ISSUES" ]; then
            echo $LINKED_ISSUES | sed -e 's/,/\n/g' >> $LINKED_ISSUES_FORMATTED
            sed -i "s/^/$CHECKSTYLE_ISSUE_URL/" $LINKED_ISSUES_FORMATTED
          fi
          echo "::set-output name=linked-issues-formatted::$LINKED_ISSUES_FORMATTED"
      - name: Check Issues
        env:
          GITHUB_TOKEN: '${{ secrets.GITHUB_TOKEN }}'
          LINKED_ISSUES: '${{ steps.format-linked-issues.outputs.linked-issues-formatted }}'
          PR_HEAD_REPO_NAME: "${{ github.event.pull_request.head.repo.full_name }}"
          GITHUB_HEAD_REF: "${{ github.head.ref }}"
        run: |
          ./.ci/no_old_refs.sh
