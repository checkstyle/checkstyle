name: Pitest

on:
  push:
    branches:
      - master
  pull_request:

jobs:
  pitest:
    strategy:
      matrix:
        profile:
          - pitest-coding-1-(1)
          - pitest-coding-1-(2)
          - pitest-coding-1-(3)
          - pitest-coding-1-(4)
          - pitest-coding-1-(5)
          - pitest-coding-1-(6)
          - pitest-coding-1-(7)
          - pitest-coding-1-(8)
          - pitest-coding-1-(9)
          - pitest-coding-1-(10)
          - pitest-coding-1-(11)
          - pitest-coding-1-(12)
          - pitest-coding-1-(13)
          - pitest-coding-1-(14)
          - pitest-coding-1-(15)
          - pitest-coding-1-(16)
          - pitest-coding-1-(17)
          - pitest-coding-1-(18)
          - pitest-coding-1-(19)
          - pitest-coding-1-(20)
          - pitest-coding-1-(21)
          - pitest-coding-1-(22)
          - pitest-coding-1-(23)
          - pitest-coding-1-(24)
          - pitest-coding-1-(25)
          - pitest-coding-1-(26)
          - pitest-coding-1-(27)
          - pitest-coding-1-(28)
        # GUI package needs better test coverage before adding to execution.
        # - pitest-gui
    runs-on: ubuntu-latest
    continue-on-error: true
    steps:
      - name: Set up JDK 11
        uses: actions/setup-java@v1
        with:
          java-version: 11
      - name: Install groovy
        run: sudo apt install groovy
      - name: Setup local maven cache
        uses: actions/cache@v2
        with:
          path: ~/.m2/repository
          key: checkstyle-maven-cache-${{ hashFiles('**/pom.xml') }}
      - name: Checkout
        uses: actions/checkout@v2
      - name: Generate ${{ matrix.profile }} report
        run: |
          mvn -e --no-transfer-progress -P"pitest-coding-1" clean test-compile \
          org.pitest:pitest-maven:mutationCoverage
      - name: Check ${{ matrix.profile }} report
        run: |
          groovy ./.ci/pitest-survival-check-xml.groovy pitest-coding-1
      - name: Stage results
        if: failure() || github.ref == 'refs/heads/master'
        run: |
          mkdir staging && cp -r target/pit-reports/ staging
      - name: Archive code coverage results
        if: failure() || github.ref == 'refs/heads/master'
        uses: actions/upload-artifact@v2
        with:
          name: ${{ matrix.profile }}-coverage-report
          path: staging
          retention-days: 7
